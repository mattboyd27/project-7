---
title: "A Machine Learning Approach to MLB Catcher Framing"
author: "Nathan Hemenway and Matthew Boyd"
date: "12/16/2021"
output: pdf_document
---


<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

```{r setup, include=FALSE}
library(tidyverse)
library(glmnet)
library(gbm)
library(randomForest)
library(caret)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
load("Data/usable_data.Rda")
x=c(-0.95,0.95,0.95,-0.95,-0.95)
y=c(1.5,1.5,3.5,3.5,1.5)
sz=data.frame(x,y)
```

# Motivation
 
Catcher framing is the art of making a pitch look better than it really is. This is a skill a catcher can have to convince the umpire to call a pitch that would otherwise be called a ball, a strike. If a pitch is for all intents and purposes a ball, then the batter likely will not swing at it. Then if the catcher can make it appear like a strike to the umpire, the umpire will call it a strike and bring the batter one step closer to an out. This is an obvious advantage, since the more strike outs take place, the less of opportunity the opposing team has to score runs while at-bat. 

Our idea to measure this phenomenon is to use statistical machine learning methods in order to predict whether a given pitch is a strike. Given the nature of baseball, there will be pitches that are likely strikes and likely balls. If a catcher can convince the umpire to call a likely ball a strike, then that catcher is a good catcher and gets credited for that pitch. On the other hand, if the umpire calls what should have been a strike a ball, then the catcher did not do a good job and is penalized for the pitch. We sought to find out which catchers are best at pitch framing by predicting how likely the pitches thrown are to be strikes, and then seeing how well the catchers can turn them into strikes.

# Methodology

Our methodology is to use available data to predict whether a pitch will be a strike for all data points up until the catcher catches the ball. This will give us a good idea of whether any pitch, given a number of characteristics, will be called a strike or called a ball. From the model output, we can get a probability that every pitch will be a strike and compare that to the observed outcome of the pitch. From here we can find out which catchers during the 2021 season excelled at getting more called strikes than their probabilities say they would.   

## Data

The data contains pitch characteristics for every pitch thrown during the 2021 Major League Baseball season. It was scraped from [Baseball Savant](https://baseballsavant.mlb.com/) using the [baseballr](https://billpetti.github.io/baseballr/) package. The scraped data contains ~700,000 rows with ~90 columns. We are only interested in pitches that were a called strike or a ball. This is because if the batter swung at a pitch, how the catcher presents the pitch doesn't matter. This left ~350,000 rows to model from.

## Variables

## Models

We chose to predict whether a pitch is a strike on several models to find the model with the highest accuracy. The model chosen will be the model used on the results.

## Logistic Regression

```{r}
set.seed(445)
load("Data/usable_data.Rda")
data_no_catchers <- usable_data[, -18]

train <- sample(1:nrow(data_no_catchers), nrow(data_no_catchers)/2)
test <- (-train)

log_reg_fit <- glm(strike ~ ., data=data_no_catchers[train, ], family='binomial')
summary(log_reg_fit)

pred <- predict.glm(log_reg_fit, type='response', newdata = data_no_catchers[test, ])
pred[pred >= 0.5] <- 'strike'
pred[pred < 0.5] <- 'ball'

conf_mx <- table(pred=pred, true=data_no_catchers[test, ]$strike)
error <- (conf_mx[2] + conf_mx[3])/length(pred)

conf_mx
1-error
```

We started with a logistic regression classifier using the selected variables as a preliminary model for predicting strikes. The model did not perform very impressively, with a prediction accuracy of 0.67. The summary for the logistic regression model gives which predictors are statistically significant, which included: 
- Pitch type, release speed, z release position
- Whether the batter is a lefty/righty
- Count
- Where the pitch landed
- Most of the innings
- Batter height
- Whether it was a home game

## Ridge Regression and LASSO

#Ridge Regression

```{r}
set.seed(445)
library(glmnet)

x <- model.matrix(strike ~ ., data = data_no_catchers)[, -1]
y <- data_no_catchers$strike

lambda <- seq(0.001, 10, length=100)

#Create training and test data set
train <- sample(1:nrow(x), nrow(x)/2)
test <- (-train)
ridge_reg_fit <-  glmnet(x[train,], y[train], alpha = 0, lambda = lambda, family='binomial')

#Choose lambda
cv_ridge <- cv.glmnet(x[train, ], y[train], alpha=0, family='binomial')
lambda_choice <- cv_ridge$lambda.min

#Get predictions
ridge_predict <- predict(ridge_reg_fit, s = lambda_choice, newx = x[test, ], type = 'class')

#Confusion matrix
ridge_conf_mx <- table(pred=ridge_predict, true=y[test])
ridge_conf_mx
error <- (ridge_conf_mx[2] + ridge_conf_mx[3])/length(ridge_predict)
1-error
```
The ridge regression model performed modestly with a prediction accuracy of 0.672. This is hardly any different from the logistic regression model, so it also is not the best choice of model to be used to rank the catchers.

#LASSO

```{r}
set.seed(445)
lasso_fit <- glmnet(x[train, ], y[train], alpha = 1, lambda = lambda, family = 'binomial')
cv_lasso <- cv.glmnet(x[train, ], y[train], alpha = 1, family='binomial')

#Lambda choice
lasso_lam <- cv_lasso$lambda.min

#Get predictions
lasso_predict <- predict(lasso_fit, s = lasso_lam, newx = x[test, ], type = 'class')

#Get coefficients
lasso_coeff <- predict(lasso_fit, s = lasso_lam, type = 'coefficients')
lasso_coeff

non_zero_lasso_coef <- lasso_coeff[lasso_coeff != 0]
#Confusion matrix
lasso_mx <- table(pred=lasso_predict, true=y[test])
lasso_mx
error <- (lasso_mx[2] + lasso_mx[3])/length(lasso_predict)
1-error
```

The model obtained using the LASSO gave a similar prediction accuracy as the logistic and ridge regression models at 0.673. The LASSO also performs variable selection, and gave non-zero coefficients for:
- Pitch type
- Count
- Outs and Inning
- Batter height
- Whether the game is home or away
- Where the pitch landed


### Random Forest

### Boosting

# Results

To give credit to each catcher, we use this equation for every pitch:  
  
 - If observed strike: 1 - Strike Probability  
 - If observed ball: Strike Probability * -1  
 
To give an example, below is a plot of the strike zone. Umpires will try to make a call of a strike or ball if the pitch is located inside the rectangle. However, umpires don't have access to a strike zone while actually making calls themselves, so there will be some error as to whether a pitch an umpire calls a strike, is actually a strike (inside the strike zone).  

The point located inside the strike zone is a theoretical location of a pitch with a 0.9 strike probability. That's quite high but it makes sense, given the pitch is in the strike zone. The pitch outside of the strike zone has a 0.2 strike probability since the pitch lands outside the strike zone. If the pitch with a 0.9 strike probability gets called a strike, the catcher will earn 1 - 0.9 = 0.1 strikes worth of credit. This is a small contribution given that the pitch is more likely to be a strike anyway. However, if the pitch gets called a ball, he will lose 0.9 strikes worth of credit which is a significant loss. That is because the catcher could have could have presented the pitch to the umpire very poorly, and he deserves to be be given credit with losing a strike for his team. If we look at the pitch out of the zone, if that pitch is an observed called strike, the catcher will receive 1 - 0.2 = 0.8 strikes worth of credit. That's a big gain for the catcher's team because he turned a pitch, more likely going to be a ball, into a strike and he should be rewarded. If that pitch is an observed ball, he will only lose -0.2 strikes worth of credit. That's small because the pitch is likely to be a ball anyway.  
 
```{r, fig.width=2, fig.height=2}
ggplot()+
  geom_path(data = sz, aes(x = x, y = y)) +
  xlim(-1.8, 1.8) +
  ylim(0.5, 5) +
  coord_equal() +
  geom_point(aes(x = .5, y = 2.5)) +
  geom_text(aes(x = 0.6, y = 2.8, label = "0.9")) +
  geom_point(aes(x = -.5, y = 4)) +
  geom_text(aes(x = -0.4, y = 4.3, label = "0.2")) +
  theme_minimal()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) 
```

Once we have an accurate model this approach is completed for every pitch in th 2021 Major League Baseball season since we will have a strike probability and we will know the observed outcome of the pitch (called strike or ball). This way we can see which catcher's are better at presenting pitches to the umpire to benefit their team.

# Conclusion
